<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ingredient Box Game</title>
<style>
:root {
  --bg:#071022;
  --card-bg:#0f1a33;
  --text:#f0f0f0;
  --accent:#ffcc00;
  --button:#1a2a50;
  --common:#cccccc;
  --rare:#66ccff;
  --epic:#ff99ff;
  --missing:#555555;
}
body {
  margin:0;
  font-family:sans-serif;
  background:var(--bg);
  color:var(--text);
  display:flex;
  flex-direction:column;
  align-items:center;
  padding:1rem;
}
h1 { text-align:center; }
.stats, .inventory, .recipes, .actions, .trade { margin:1rem 0; width:100%; max-width:500px; }
.inventory div, .recipes div, .trade div {
  display:flex;
  justify-content:space-between;
  flex-wrap:wrap;
  padding:0.3rem 0.5rem;
  background:var(--card-bg);
  margin:0.2rem 0;
  border-radius:6px;
}
button {
  background:var(--button);
  border:none;
  color:var(--text);
  padding:0.5rem 1rem;
  margin:0.2rem;
  border-radius:6px;
  font-size:1rem;
  cursor:pointer;
}
button:disabled { opacity:0.4; cursor:not-allowed; }
.log { max-height:150px; overflow-y:auto; width:100%; background:var(--card-bg); padding:0.5rem; border-radius:6px; font-size:0.9rem; }
.popup {
  position:fixed;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  background:var(--card-bg);
  padding:1rem 2rem;
  border-radius:10px;
  font-size:1.2rem;
  text-align:center;
  display:none;
  z-index:100;
}
.rarity-common { color:var(--common); }
.rarity-rare { color:var(--rare); }
.rarity-epic { color:var(--epic); }
.missing { color:var(--missing); }
.toggle {
  margin:0.5rem 0;
  cursor:pointer;
  color:var(--accent);
  text-decoration:underline;
}
</style>
</head>
<body>
<h1>Ingredient Box Game</h1>
<div class="stats">
  Points: <span id="points">0</span> | Free Boxes: <span id="freeBoxes">3</span>
</div>

<div class="actions">
  <button id="buyBox">Buy Premium Box (20 pts)</button>
  <button id="buyUltraBox">Buy Ultra Premium Box (50 pts)</button>
  <button id="openBox">Open Free Box</button>
</div>

<div class="toggle" id="toggleCraftable">Show: All Recipes</div>

<div class="inventory">
  <h3>Inventory</h3>
  <div id="inventoryList"></div>
</div>

<div class="recipes">
  <h3>Recipes</h3>
  <div id="recipeList"></div>
</div>

<div class="trade">
  <h3>Trade</h3>
  <div id="tradeList"></div>
</div>

<div class="log" id="log"></div>
<div class="popup" id="popup"></div>

<script>
// --- GAME STATE ---
let state = {
  points:0,
  inventory:{},
  inventoryLimit:30,
  freeBoxes:3,
  lastFreeBox:Date.now(),
  showCraftableOnly:false
};

// --- INGREDIENTS ---
const INGREDIENTS = [
  {name:"Flour", rarity:"common"},
  {name:"Egg", rarity:"common"},
  {name:"Milk", rarity:"common"},
  {name:"Sugar", rarity:"common"},
  {name:"Cheese", rarity:"rare"},
  {name:"Butter", rarity:"rare"},
  {name:"Chocolate", rarity:"epic"},
  {name:"Vanilla", rarity:"epic"},
  {name:"Strawberry", rarity:"rare"},
  {name:"Honey", rarity:"epic"},
  {name:"Blueberry", rarity:"epic"},
];

// --- RECIPES ---
let RECIPES = [
  {name:"Cake", ingredients:["Flour","Egg","Sugar"], points:15},
  {name:"Cheese Omelette", ingredients:["Egg","Cheese","Milk"], points:20},
  {name:"Chocolate Milk", ingredients:["Milk","Chocolate"], points:25},
  {name:"Berry Tart", ingredients:["Flour","Butter","Strawberry"], points:30},
  {name:"Honey Chocolate", ingredients:["Chocolate","Honey"], points:40},
];

// Generate extra recipes
function generateExtraRecipes(){
  const extra = [];
  for(let i=0;i<5;i++){
    const count = 2 + Math.floor(Math.random()*3);
    const ingredients = [];
    for(let j=0;j<count;j++){
      const ing = INGREDIENTS[Math.floor(Math.random()*INGREDIENTS.length)].name;
      if(!ingredients.includes(ing)) ingredients.push(ing);
    }
    const points = ingredients.length * 10;
    extra.push({name:"Recipe "+(i+1), ingredients, points});
  }
  // Sort by points descending
  extra.sort((a,b)=>b.points-a.points);
  RECIPES = RECIPES.concat(extra);
}
generateExtraRecipes();

// --- TRADE RULES ---
const TRADE_RULES = [
  {give:"common", amount:5, receive:"rare"},
  {give:"rare", amount:3, receive:"epic"},
];

// --- LOCAL STORAGE ---
function saveState(){ localStorage.setItem("ingredientGameState",JSON.stringify(state)); }
function loadState(){ 
  const s=localStorage.getItem("ingredientGameState"); 
  if(s){ state=JSON.parse(s); } 
}

// --- LOG AND POPUP ---
function pushLog(msg){ const log=document.getElementById("log"); log.innerHTML=msg+"<br>"+log.innerHTML; }
function showPopup(msg){
  const p=document.getElementById("popup");
  p.innerHTML=msg;
  p.style.display="block";
  setTimeout(()=>{p.style.display="none";},1500);
}

// --- HELPERS ---
function getIngredient(name){ return INGREDIENTS.find(i=>i.name===name); }
function rarityColor(r){ return r==="common"?"var(--common)":r==="rare"?"var(--rare)":"var(--epic)"; }
function addIngredient(name,qty=1){
  const total = Object.values(state.inventory).reduce((a,b)=>a+b,0);
  if(total + qty > state.inventoryLimit){
    pushLog("Inventory full! Cannot add " + name);
    showPopup("Inventory Full!");
    return false;
  }
  state.inventory[name]=(state.inventory[name]||0)+qty;
  renderInventory(); renderRecipes(); renderTrade(); saveState();
  return true;
}

// --- RENDER ---
function renderInventory(){
  const container = document.getElementById("inventoryList");
  container.innerHTML="";
  const total = Object.values(state.inventory).reduce((a,b)=>a+b,0);
  if(total >= state.inventoryLimit*0.8) showPopup("Inventory almost full!");
  for(const [ing,qty] of Object.entries(state.inventory)){
    const data=getIngredient(ing);
    const div=document.createElement("div");
    div.innerHTML=`${ing} x${qty} <span class="rarity-${data.rarity}">[${data.rarity}]</span>`;
    container.appendChild(div);
  }
}

function renderRecipes(){
  const container=document.getElementById("recipeList");
  container.innerHTML="";
  RECIPES.forEach(r=>{
    const canCraft = r.ingredients.every(i=> (state.inventory[i]||0)>0);
    if(state.showCraftableOnly && !canCraft) return;
    const div=document.createElement("div");
    // Ingredient text, grey out missing ones
    const ingText = r.ingredients.map(i=> (state.inventory[i]||0)>0 ? i : `<span class="missing">${i}</span>`).join(", ");
    div.innerHTML=`${r.name} (${r.points} pts) - Ingredients: ${ingText} `;
    const btn=document.createElement("button");
    btn.textContent="Craft";
    btn.disabled = !canCraft;
    btn.onclick=()=>{
      r.ingredients.forEach(i=>state.inventory[i]--);
      state.points += r.points;
      document.getElementById("points").textContent=state.points;
      renderInventory(); renderRecipes(); renderTrade();
      pushLog(`Crafted ${r.name} for ${r.points} pts`);
      showPopup("Yum!");
      saveState();
    };
    div.appendChild(btn);
    container.appendChild(div);
  });
}

function renderTrade(){
  const container=document.getElementById("tradeList");
  container.innerHTML="";
  TRADE_RULES.forEach(rule=>{
    const owned=Object.entries(state.inventory)
      .filter(([n,v])=>getIngredient(n).rarity===rule.give)
      .reduce((a,[n,v])=>a+v,0);
    if(Math.floor(owned/rule.amount)>0){
      const div=document.createElement("div");
      div.textContent=`Trade ${rule.amount} ${rule.give} for 1 ${rule.receive}`;
      const btn=document.createElement("button");
      btn.textContent="Trade";
      btn.onclick=()=>{
        if(confirm(`Trade ${rule.amount} ${rule.give} for 1 ${rule.receive}?`)){
          let left=rule.amount;
          const traded = [];
          for(const [n,v] of Object.entries(state.inventory)){
            if(getIngredient(n).rarity===rule.give && left>0){
              const use=Math.min(v,left);
              state.inventory[n]-=use;
              traded.push(`${n} x${use}`);
              left -= use;
            }
          }
          const candidates=INGREDIENTS.filter(i=>i.rarity===rule.receive);
          const received = candidates[Math.floor(Math.random()*candidates.length)].name;
          addIngredient(received);
          renderInventory(); renderTrade();
          pushLog(`Traded [${traded.join(", ")}], received ${received}`);
          showPopup(`Traded [${traded.join(", ")}], received ${received}`);
        }
      };
      div.appendChild(btn);
      container.appendChild(div);
    }
  });
}

// --- BOX MECHANICS ---
function openBox(tier){
  let boxCount = 2 + Math.floor(Math.random()*3);
  const box = [];
  for(let i=0;i<boxCount;i++){
    let candidates;
    if(tier==="free") candidates = INGREDIENTS.filter(i=>i.rarity!=="epic");
    else if(tier==="premium"){
      const r=Math.random();
      if(r<0.4) candidates=INGREDIENTS.filter(i=>i.rarity==="common");
      else if(r<0.8) candidates=INGREDIENTS.filter(i=>i.rarity==="rare");
      else candidates=INGREDIENTS.filter(i=>i.rarity==="epic");
    } else if(tier==="ultra"){
      const r=Math.random();
      if(r<0.2) candidates=INGREDIENTS.filter(i=>i.rarity==="common");
      else if(r<0.6) candidates=INGREDIENTS.filter(i=>i.rarity==="rare");
      else candidates=INGREDIENTS.filter(i=>i.rarity==="epic");
    }
    box.push(candidates[Math.floor(Math.random()*candidates.length)].name);
  }
  addIngredients(box);
  showPopup(`Opened ${tier} box: ${box.join(", ")}`);
  pushLog(`Opened ${tier} box: ${box.join(", ")}`);
}

function addIngredients(box){ box.forEach(i=>addIngredient(i)); }

// --- BUY BOX BUTTONS ---
document.getElementById("buyBox").onclick = () => {
  if(state.points<20){ pushLog("Not enough points!"); showPopup("Need 20 points!"); return; }
  state.points-=20; document.getElementById("points").textContent=state.points;
  openBox("premium");
};
document.getElementById("buyUltraBox").onclick = () => {
  if(state.points<50){ pushLog("Not enough points!"); showPopup("Need 50 points!"); return; }
  state.points-=50; document.getElementById("points").textContent=state.points;
  openBox("ultra");
};

document.getElementById("openBox").onclick = () => {
  if(state.freeBoxes>0){
    state.freeBoxes--;
    document.getElementById("freeBoxes").textContent=state.freeBoxes;
    openBox("free");
  } else { pushLog("No free boxes!"); showPopup("No free boxes!"); }
};

// --- TOGGLE CRAFTABLE ---
document.getElementById("toggleCraftable").onclick = () => {
  state.showCraftableOnly = !state.showCraftableOnly;
  document.getElementById("toggleCraftable").textContent = state.showCraftableOnly ? "Show: Craftable Only" : "Show: All Recipes";
  renderRecipes();
};

// --- FREE BOX TIMER ---
setInterval(()=>{
  const now=Date.now();
  if(now - state.lastFreeBox >= 15*60*1000){
    if(state.freeBoxes<3){ state.freeBoxes++; document.getElementById("freeBoxes").textContent=state.freeBoxes; }
    state.lastFreeBox=now;
    pushLog("A free box is ready!"); saveState();
  }
},1000);

// --- INITIAL LOAD ---
loadState();
document.getElementById("points").textContent=state.points;
document.getElementById("freeBoxes").textContent=state.freeBoxes;
renderInventory(); renderRecipes(); renderTrade();
</script>
</body>
</html>
