<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dessert Box Game</title>
<style>
:root {
  --bg:#071022;
  --card-bg:#0f1a33;
  --text:#f0f0f0;
  --accent:#ffcc00;
  --button:#1a2a50;
  --common:#cccccc;
  --rare:#66ccff;
  --epic:#ff99ff;
  --legendary:#ff5500;
  --missing:#555555;
  --gradient-free: linear-gradient(135deg,#1e3c72,#2a5298);
  --gradient-premium: linear-gradient(135deg,#0f850f,#45c45d);
  --gradient-ultra: linear-gradient(135deg,#8a2be2,#c77fff);
}
body {
  margin:0;
  font-family:sans-serif;
  background:var(--bg);
  color:var(--text);
  display:flex;
  flex-direction:column;
  align-items:center;
  padding:1rem;
}
h1 { text-align:center; }
.stats, .inventory, .recipes, .actions, .trade { margin:1rem 0; width:100%; max-width:500px; }
.inventory div, .recipes div, .trade div {
  display:flex;
  justify-content:space-between;
  flex-wrap:wrap;
  padding:0.3rem 0.5rem;
  background:var(--card-bg);
  margin:0.2rem 0;
  border-radius:6px;
}
button {
  background:var(--button);
  border:none;
  color:var(--text);
  padding:0.5rem 1rem;
  margin:0.2rem;
  border-radius:6px;
  font-size:1rem;
  cursor:pointer;
  transition:0.3s;
}
button.selected { background:var(--accent); color:#000; }
button:disabled { opacity:0.4; cursor:not-allowed; }
.log { max-height:150px; overflow-y:auto; width:100%; background:var(--card-bg); padding:0.5rem; border-radius:6px; font-size:0.9rem; }
.popup {
  position:fixed;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  background:var(--card-bg);
  padding:1rem 2rem;
  border-radius:10px;
  font-size:1.2rem;
  text-align:center;
  display:none;
  z-index:100;
}
.rarity-common { color:var(--common); }
.rarity-rare { color:var(--rare); }
.rarity-epic { color:var(--epic); }
.rarity-legendary { color:var(--legendary); }
.missing { color:var(--missing); }
.toggle-group { display:flex; justify-content:center; margin:0.5rem 0; }
.toggle-group button { margin:0 0.2rem; }
.box-animation {
  position:fixed;
  width:100px;
  height:100px;
  background:var(--gradient-free);
  top:50%; left:50%;
  transform:translate(-50%,-50%) scale(0);
  border-radius:10px;
  display:flex;
  justify-content:center;
  align-items:center;
  color:#fff;
  font-weight:bold;
  font-size:1rem;
  z-index:200;
  animation:openBox 0.8s forwards;
}
@keyframes openBox {
  0% { transform:translate(-50%,-50%) scale(0); opacity:0; }
  50% { transform:translate(-50%,-50%) scale(1.2); opacity:1; }
  100% { transform:translate(-50%,-50%) scale(1); opacity:0; }
}
.star { color:gold; margin-left:2px; }
</style>
</head>
<body>
<h1>Dessert Box Game</h1>
<div class="stats">
  Points: <span id="points">0</span> | Free Boxes: <span id="freeBoxes">3</span>
</div>

<div class="actions">
  <button id="buyBox" style="background:var(--gradient-premium)">Buy Premium Box (20 pts)</button>
  <button id="buyUltraBox" style="background:var(--gradient-ultra)">Buy Ultra Premium Box (50 pts)</button>
  <button id="openBox" style="background:var(--gradient-free)">Open Free Box</button>
</div>

<div class="inventory">
  <h3>Inventory (<span id="inventoryCount">0</span>/<span id="inventoryMax">35</span>)</h3>
  <div class="toggle-group">
    <button id="inventoryAll" class="selected">All</button>
    <button id="inventoryInStock">In Stock Only</button>
  </div>
  <div id="inventoryList"></div>
</div>

<div class="recipes">
  <h3>Recipes</h3>
  <div class="toggle-group">
    <button id="recipesAll" class="selected">All Recipes</button>
    <button id="recipesCraftable">Craftable Only</button>
  </div>
  <div id="recipeList"></div>
</div>

<div class="trade">
  <h3>Trading Post</h3>
  <div id="tradeList"></div>
</div>

<div class="log" id="log"></div>
<div class="popup" id="popup"></div>

<script>
// --- GAME STATE ---
let state = {
  points:0,
  inventory:{},
  inventoryLimit:35,
  freeBoxes:3,
  lastFreeBox:Date.now(),
  showCraftableOnly:false,
  showInStockOnly:false,
  recipeCrafted:{},
  tradeOptions:[],
  tradeRefreshTime:0
};

// --- INGREDIENTS ---
const INGREDIENTS = [
  {name:"Flour", rarity:"common", points:5},
  {name:"Egg", rarity:"common", points:5},
  {name:"Milk", rarity:"common", points:5},
  {name:"Sugar", rarity:"common", points:5},
  {name:"Cheese", rarity:"rare", points:15},
  {name:"Butter", rarity:"rare", points:15},
  {name:"Chocolate", rarity:"epic", points:30},
  {name:"Vanilla", rarity:"epic", points:30},
  {name:"Strawberry", rarity:"rare", points:15},
  {name:"Honey", rarity:"epic", points:30},
  {name:"Blueberry", rarity:"epic", points:30},
  {name:"Dragonfruit", rarity:"legendary", points:60}
];

// --- RECIPES ---
const RECIPES = [
  {name:"Cake", ingredients:["Flour","Egg","Sugar"], points:15},
  {name:"Cheese Omelette", ingredients:["Egg","Cheese","Milk"], points:25},
  {name:"Chocolate Milk", ingredients:["Milk","Chocolate"], points:35},
  {name:"Strawberry Tart", ingredients:["Flour","Butter","Strawberry"], points:35},
  {name:"Berry Jam", ingredients:["Sugar","Blueberry","Strawberry"], points:50},
  {name:"Ice Cream", ingredients:["Sugar","Milk","Vanilla"], points:40},
  {name:"Honey Chocolate", ingredients:["Chocolate","Honey"], points:60},
  {name:"Vanilla Cake", ingredients:["Flour","Egg","Vanilla"], points:40},
  {name:"Blueberry Pie", ingredients:["Flour","Butter","Blueberry"], points:50},
  {name:"Dragonfruit Surprise", ingredients:["Dragonfruit","Egg","Sugar"], points:70}
];
RECIPES.sort((a,b)=>b.points-a.points);

// --- LOCAL STORAGE ---
function saveState(){ localStorage.setItem("ingredientGameState",JSON.stringify(state)); }
function loadState(){ 
  const s=localStorage.getItem("ingredientGameState"); 
  if(s){ state=JSON.parse(s); } 
}

// --- LOG / POPUP ---
function pushLog(msg){ const log=document.getElementById("log"); log.innerHTML=msg+"<br>"+log.innerHTML; }
function showPopup(msg){
  const p=document.getElementById("popup");
  p.innerHTML=msg;
  p.style.display="block";
  setTimeout(()=>{p.style.display="none";},1500);
}

// --- HELPERS ---
function getIngredient(name){ return INGREDIENTS.find(i=>i.name===name); }
function addIngredient(name,qty=1){
  const total = Object.values(state.inventory).reduce((a,b)=>a+b,0);
  if(total + qty > state.inventoryLimit){ pushLog("Inventory full!"); showPopup("Inventory Full!"); return false; }
  state.inventory[name]=(state.inventory[name]||0)+qty;
  renderInventory(); renderRecipes(); renderTrade(); saveState();
  return true;
}

// --- BOX ANIMATION ---
function animateBox(tier, callback){
  const boxDiv = document.createElement("div");
  boxDiv.className = "box-animation";
  boxDiv.style.background = tier==="free"? "var(--gradient-free)":tier==="premium"? "var(--gradient-premium)":"var(--gradient-ultra)";
  boxDiv.textContent = tier.charAt(0).toUpperCase()+tier.slice(1);
  document.body.appendChild(boxDiv);
  setTimeout(()=>{
    document.body.removeChild(boxDiv);
    callback();
  },800);
}

// --- OPEN BOX ---
function openBox(tier){
  animateBox(tier, ()=>{
    let minItems = tier==="free"?2:tier==="premium"?3:4;
    let maxItems = tier==="free"?3:tier==="premium"?4:5;
    let count = minItems + Math.floor(Math.random()*(maxItems-minItems+1));
    const box = [];
    for(let i=0;i<count;i++){
      let r=Math.random();
      let candidates=[];
      if(i===0){ candidates=INGREDIENTS.filter(x=>x.rarity=="common"); }
      else if(tier==="free"){
        if(r<0.01) candidates=INGREDIENTS.filter(x=>x.rarity=="legendary");
        else if(r<0.02) candidates=INGREDIENTS.filter(x=>x.rarity=="epic");
        else if(r<0.1) candidates=INGREDIENTS.filter(x=>x.rarity=="rare");
        else candidates=INGREDIENTS.filter(x=>x.rarity=="common");
      } else if(tier==="premium"){
        if(r<0.02) candidates=INGREDIENTS.filter(x=>x.rarity=="legendary");
        else if(r<0.05) candidates=INGREDIENTS.filter(x=>x.rarity=="epic");
        else if(r<0.2) candidates=INGREDIENTS.filter(x=>x.rarity=="rare");
        else candidates=INGREDIENTS.filter(x=>x.rarity=="common");
      } else { 
        if(r<0.05) candidates=INGREDIENTS.filter(x=>x.rarity=="legendary");
        else if(r<0.1) candidates=INGREDIENTS.filter(x=>x.rarity=="epic");
        else if(r<0.25) candidates=INGREDIENTS.filter(x=>x.rarity=="rare");
        else candidates=INGREDIENTS.filter(x=>x.rarity=="common");
      }
      let item = candidates[Math.floor(Math.random()*candidates.length)].name;
      box.push(item);
      addIngredient(item);
    }
    showPopup(`Opened ${tier} box: ${box.join(", ")}`);
    pushLog(`Opened ${tier} box: ${box.join(", ")}`);
  });
}

// --- RENDER INVENTORY ---
function renderInventory(){
  const container = document.getElementById("inventoryList");
  container.innerHTML="";
  let totalItems = Object.values(state.inventory).reduce((a,b)=>a+b,0);
  document.getElementById("inventoryCount").textContent=totalItems;
  Object.entries(state.inventory)
    .filter(([name])=> getIngredient(name)) // only known ingredients
    .sort((a,b)=>{
      const rank = {legendary:4, epic:3, rare:2, common:1};
      return rank[getIngredient(b[0]).rarity]-rank[getIngredient(a[0]).rarity];
    })
    .forEach(([name,qty])=>{
      if(state.showInStockOnly && qty<=0) return;
      const data = getIngredient(name);
      const div = document.createElement("div");
      div.innerHTML=`${name} x${qty} <span class="rarity-${data.rarity}">[${data.rarity}]</span>`;
      container.appendChild(div);
    });
}

// --- RENDER RECIPES ---
function renderRecipes(){
  const container = document.getElementById("recipeList");
  container.innerHTML="";
  RECIPES.forEach(r=>{
    const canCraft = r.ingredients.every(i=> (state.inventory[i]||0)>0);
    if(state.showCraftableOnly && !canCraft) return;
    const div=document.createElement("div");
    const ingText = r.ingredients.map(i=> {
      const ing = getIngredient(i);
      return ing && (state.inventory[i]||0)>0 ? i : `<span class="missing">${i}</span>`;
    }).join(", ");
    const count = state.recipeCrafted[r.name]||0;
    let stars="";
    if(count>=1 && count<=2) stars="★";
    else if(count>=3 && count<=5) stars="★★";
    else if(count>=6) stars="★★★";
    div.innerHTML=`${r.name} (${r.points} pts) - Ingredients: ${ingText} <span class="star">${stars}</span>`;
    const btn=document.createElement("button");
    btn.textContent="Craft";
    btn.disabled = !canCraft;
    btn.onclick=()=>{
      r.ingredients.forEach(i=>state.inventory[i]--);
      state.points+=r.points;
      document.getElementById("points").textContent=state.points;
      state.recipeCrafted[r.name]=(state.recipeCrafted[r.name]||0)+1;
      renderInventory(); renderRecipes(); renderTrade();
      pushLog(`Crafted ${r.name} for ${r.points} pts`);
      showPopup("Yum!");
      saveState();
    };
    div.appendChild(btn);
    container.appendChild(div);
  });
}

// --- RENDER TRADING POST ---
function generateTradeOptions(){
  const inventoryItems = Object.entries(state.inventory).filter(([n,q])=>q>0).map(([n])=>n);
  if(inventoryItems.length===0) return;
  state.tradeOptions=[];
  for(let i=0;i<3;i++){
    const give = inventoryItems[Math.floor(Math.random()*inventoryItems.length)];
    let receiveCandidates = INGREDIENTS.filter(x=>x.name!==give);
    const receive = receiveCandidates[Math.floor(Math.random()*receiveCandidates.length)].name;
    state.tradeOptions.push({give:give, receive:receive});
  }
  state.tradeRefreshTime=Date.now();
}

function renderTrade(){
  const container=document.getElementById("tradeList");
  container.innerHTML="";
  if(!state.tradeOptions) state.tradeOptions=[];
  state.tradeOptions.forEach((opt,idx)=>{
    const div=document.createElement("div");
    div.textContent=`Trade 5 ${opt.give} → 1 ${opt.receive}`;
    const btn=document.createElement("button");
    btn.textContent="Trade";
    btn.disabled=(state.inventory[opt.give]||0)<5;
    btn.onclick=()=>{
      if(confirm(`Trade 5 ${opt.give} for 1 ${opt.receive}?`)){
        state.inventory[opt.give]-=5;
        addIngredient(opt.receive,1);
        pushLog(`Traded 5 ${opt.give}, received 1 ${opt.receive}`);
        showPopup(`Traded 5 ${opt.give}, received 1 ${opt.receive}`);
        renderInventory(); renderTrade(); saveState();
      }
    };
    div.appendChild(btn);
    container.appendChild(div);
  });
  const refreshBtn=document.createElement("button");
  refreshBtn.textContent="Refresh Trades";
  const cooldown = Math.max(0,60 - Math.floor((Date.now()-state.tradeRefreshTime)/1000));
  refreshBtn.disabled = cooldown>0;
  refreshBtn.onclick=()=>{
    generateTradeOptions();
    renderTrade();
  };
  if(cooldown>0) refreshBtn.textContent+=` (${cooldown}s)`;
  container.appendChild(refreshBtn);
}

// --- BUTTONS ---
document.getElementById("buyBox").onclick = () => {
  if(state.points<20){ pushLog("Not enough points!"); showPopup("Need 20 points!"); return; }
  state.points-=20; document.getElementById("points").textContent=state.points;
  openBox("premium");
};
document.getElementById("buyUltraBox").onclick = () => {
  if(state.points<50){ pushLog("Not enough points!"); showPopup("Need 50 points!"); return; }
  state.points-=50; document.getElementById("points").textContent=state.points;
  openBox("ultra");
};
document.getElementById("openBox").onclick = () => {
  if(state.freeBoxes>0){ state.freeBoxes--; document.getElementById("freeBoxes").textContent=state.freeBoxes; openBox("free"); }
  else { pushLog("No free boxes!"); showPopup("No free boxes!"); }
};

// --- TOGGLE BUTTONS ---
function toggleButtons(group, selectedBtn){
  group.forEach(b=>b.classList.remove("selected"));
  selectedBtn.classList.add("selected");
}
document.getElementById("recipesAll").onclick = ()=>{ state.showCraftableOnly=false; renderRecipes(); toggleButtons([document.getElementById("recipesAll"),document.getElementById("recipesCraftable")], document.getElementById("recipesAll")); };
document.getElementById("recipesCraftable").onclick = ()=>{ state.showCraftableOnly=true; renderRecipes(); toggleButtons([document.getElementById("recipesAll"),document.getElementById("recipesCraftable")], document.getElementById("recipesCraftable")); };
document.getElementById("inventoryAll").onclick = ()=>{ state.showInStockOnly=false; renderInventory(); toggleButtons([document.getElementById("inventoryAll"),document.getElementById("inventoryInStock")], document.getElementById("inventoryAll")); };
document.getElementById("inventoryInStock").onclick = ()=>{ state.showInStockOnly=true; renderInventory(); toggleButtons([document.getElementById("inventoryAll"),document.getElementById("inventoryInStock")], document.getElementById("inventoryInStock")); };

// --- FREE BOX TIMER ---
setInterval(()=>{
  const now=Date.now();
  if(now-state.lastFreeBox>15*60*1000){
    if(state.freeBoxes<3){ state.freeBoxes++; document.getElementById("freeBoxes").textContent=state.freeBoxes; }
    state.lastFreeBox=now;
    pushLog("A free box is ready!"); saveState();
  }
},1000);

// --- INITIAL LOAD ---
document.addEventListener("DOMContentLoaded", () => {
    loadState();
    if(!state.inventory) state.inventory={};
    if(!state.recipeCrafted) state.recipeCrafted={};
    if(!state.tradeOptions || state.tradeOptions.length===0) generateTradeOptions();

    document.getElementById("points").textContent = state.points;
    document.getElementById("freeBoxes").textContent = state.freeBoxes;

    renderInventory();
    renderRecipes();
    renderTrade();
});
</script>
</body>
</html>
